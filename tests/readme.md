# Документация по автотестам BookTable.AI

## Структура тестов
- Все автотесты находятся в папке `tests/`.
- Основной файл: `test_main.py` — покрывает бизнес-логику, команды, обработчики, работу с базой, edge-case'ы.
- Вспомогательный файл: `test_bot.py` — для простых smoke-тестов.
- Файл `to_do.txt` — список тестов, которые ещё нужно реализовать для 100% покрытия.

## Как запускать тесты
```bash
pytest --disable-warnings --tb=short --cov=main --cov-report=term-missing
```
- Для CI/CD используется тот же вызов.
- Покрытие выводится в файл `coverage_report.txt`.

## Что покрыто тестами (на июнь 2024)
- Команды: `/start`, `/restart`, выбор языка, бюджета, пожеланий, локации, районов.
- Вся логика пользовательского флоу: от старта до финализации бронирования (без OpenAI).
- Работа с базой: сохранение пользователя, обработка ошибок соединения, edge-case'ы.
- Проверка корректности user_data, chat_log, booking_data, sessionid.
- Проверка корректности reply_markup, кнопок, inline-клавиатур.
- Проверка edge-case'ов: ошибки, исключения, неожиданные данные, пустые ответы, ошибки Telegram API.
- Проверка логирования ошибок.
- Проверка корректной работы с асинхронными методами через AsyncMock.
- Проверка корректной работы с fallback-сообщениями (например, если перевод не удался, если OpenAI не отвечает).

## Что мокируется
- Все обращения к базе данных (psycopg2.connect, курсоры, fetchone/fetchall, commit).
- Все асинхронные методы Telegram API (reply_text, delete, send_chat_action, send_message и др.) через AsyncMock.
- Все обращения к OpenAI (client.chat.completions.create, ask, detect_language, translate_message) — временно скипнуты или мокируются.

## Какие функции main.py уже покрыты
- start
- restart
- language_callback
- budget_callback
- location_callback
- area_callback
- choose_area_callback
- show_pretty_restaurants
- handle_location
- check_budget
- save_user_to_db
- get_db_connection
- is_this_user_allowed
- append_interaction_to_chat_log
- (частично) talk, translate_message, ask, detect_language (полное покрытие будет после восстановления OpenAI)

## Как добавлять новые тесты
- Используйте pytest и AsyncMock для асинхронных функций.
- Для новых функций main.py — добавляйте отдельные тесты с разными сценариями (успех, ошибка, edge-case).
- Для новых команд/обработчиков — создавайте DummyUpdate, DummyContext, мокаем все внешние вызовы.
- Для тестов, зависящих от OpenAI, используйте @pytest.mark.skip или мокайте ответы.

## Edge-case'ы и негативные сценарии
- Тесты на ошибки базы, ошибки Telegram API, неожиданные данные, пустые ответы, отсутствие user_data, некорректные callback_data, отсутствие location и т.д.
- Тесты на корректную работу с fallback-сообщениями и логированием ошибок.

## Что скипнуто и почему
- Все тесты, которые требуют реального ответа OpenAI (ask, detect_language, translate_message) — временно скипнуты до восстановления баланса.
- Тесты, где невозможно гарантировать текст ответа из-за перевода или AI — временно скипнуты.

## Рекомендации для будущих разработчиков
- Всегда мокируйте внешние сервисы и асинхронные методы.
- Для новых функций — сразу пишите тесты на успех, ошибку, edge-case.
- Для сложных сценариев — используйте patch и AsyncMock.
- Для повышения покрытия — добавляйте тесты на все ветки, исключения, альтернативные сценарии.
- После восстановления OpenAI — вернуть скипнутые тесты и добиться 100% покрытия. 